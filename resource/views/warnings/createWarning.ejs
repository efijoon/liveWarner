<style>
    table th {
        padding-top: 12px;
        padding-bottom: 12px;
        color: black;
    }

    .bidasks tr th,
    .bidasks tr td {
        padding: 10px;
        border-top: 1px solid #f1f1f1;
        vertical-align: middle;
        text-align: center;
        line-height: 1.4em;
    }

    .bidasks tr th.ask,
    .bidasks tr td.ask {
        color: #409b51;
    }

    .bidasks tr th.ask,
    .bidasks tr td.bid {
        color: #e62f2f;
    }

    .disableprice {
        color: #c2c2c2 !important;
        cursor: not-allowed;
    }
</style>

<div class="jumbotron">
    <div class="container">
        <h1 class="display-4 text-dark">بیانیه ریسک</h1>
        <p class="lead">بخش هشدارهای درون برنامه ای به درخواست کاربران راه اندازی گردیده، لازم است موارد زیر مدنظر باشد:
        </p>
        <ol>
            <li><span class="text-dark">هشدارها هم به صورت ایمیل و هم به صورت پیامک میباشند.</span></li>
            <li><span class="text-dark">هشدارها از نوع ایمیل در صورتی عمل میکنند که اینترنت شما برقرار باشد.</span></li>
            <li><span class="text-dark">ممکن است در حد 5 تا 10 دقیقه ای پس از زمان فعال شدن هشدار زمان ببرد تا هشدار به
                    دست شما برسد.</span></li>
        </ol>
    </div>
</div>

<div class="row justify-content-center">
    <button class="btn btn-success" data-toggle="modal" data-target="#create-warning-modal">ثبت هشدار جدید</button>
</div>

<div class="modal fade" id="create-warning-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle"
    aria-hidden="true">
    <div class="modal-dialog" style="color: black;" role="document">
        <div class="modal-content" style="text-align: right;">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">ایجاد هشدار جدید</h5>
            </div>
            <div class="modal-body">
                <div class="menu">
                    <div class="panel overflow-hidden open">
                        <div class="h-100">
                            <div class="h-100 w-100">
                                <div class="d-flex flex-column h-100">
                                    <form action="/warnings/makeWarning" method="post">
                                        <div class="header d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center justify-content-around text-reverse-50">
                                                <h6 class="mb-0 text-reverse mr-2">نام نماد</h6>
                                            </div>
                                            <div class="d-flex align-items-center text-muted"><span
                                                    class="mdi mdi-24px mdi-alert-circle-outline px-2 text-muted"></span><span
                                                    class="mdi p-2 mdi-24px text-primary mdi-close"></span>
                                            </div>
                                        </div>
                                        <!---->
                                        <div class="h-100 overflow-auto">
                                            <div class="overflow-auto flex-grow-1 check-for-scroll">
                                                <div class="position-relative stock-condition__search p-2">
                                                    <input type="text" name="symbolName" autocomplete="off" value="<%= old('symbolName') %>"
                                                        placeholder="نماد مورد جستجو را وارد کنید" id="searchInputControl"
                                                        class="form-control ng-valid ng-touched ng-dirty">
                                                    <!-- <button id="searchButtonControl"
                                                        class="form-control btn-info ng-valid ng-touched ng-dirty mt-3"
                                                        type="submit">جست و جو</button> -->
                                                </div>
                                            </div>
                                            <div>
                                                <form class="ng-pristine ng-invalid ng-touched">
                                                    <div id="namad-details-container" style="display: none;"></div>
                                                    <div id="bidaskTable" style="display: none;"></div>
                                                    <div id="failed-message" style="display: flex;justify-content: center;">
                                                    </div>
    
                                                    <!---->
                                                    <div class="row-list ng-pristine ng-invalid ng-touched">
                                                        <div class="p-2 font-weight-bold">تعیین شروط:</div>
                                                        <div class="row-list__item p-2">
                                                            <div
                                                                class="d-flex align-items-center position-relative ng-pristine ng-invalid ng-touched">
                                                                <div class="col-4 px-1 position-static">
                                                                    <select id="compare-field" name="compareField"
                                                                        class="custom-select h-100 ng-pristine ng-valid ng-touched">
                                                                        <option value="0">آخرین قیمت</option>
                                                                        <option value="1"> درصد تغییر قیمت
                                                                        </option>
                                                                        <option value="2"> قیمت پایانی
                                                                        </option>
                                                                        <option value="3"> درصد تغییر پایانی
                                                                        </option>
                                                                        <option value="4"> حجم معاملات
                                                                        </option>
                                                                        <option value="5"> ارزش معاملات
                                                                        </option>
                                                                        <!---->
                                                                    </select>
                                                                </div>
                                                                <div class="px-1">
                                                                    <select id="comparator" name="comparator"
                                                                        class="custom-select text-left h-100">
                                                                        <option value="gt"> بزرگتر از
                                                                        </option>
                                                                        <option value="gte"> بزرگتر یا مساوی
                                                                        </option>
                                                                        <option value="lt"> کوچکتر از
                                                                        </option>
                                                                        <option value="lte"> کوچکتر یا مساوی
                                                                        </option>
                                                                        <option value="e"> مساوی </option>
                                                                        <!---->
                                                                    </select>
                                                                </div>
                                                                <div class="px-1">
                                                                    <input type="text" id="compareNumber" name="compareNumber"  value="<%= old('compareNumber') %>"
                                                                        class="form-control text-left">
                                                                </div>
                                                            </div>
                                                            <div class="p-2">
                                                                <div>
                                                                    <div
                                                                        class="d-flex justify-content-between align-items-center my-2">
                                                                        <label for="conditionName" class="m-0">عنوان
                                                                            هشدار:
                                                                        </label>
                                                                        <div class="custom-control custom-checkbox">
                                                                            <input type="checkbox" id="customCheck"
                                                                                class="custom-control-input"><label
                                                                                for="customCheck"
                                                                                class="custom-control-label">
                                                                                نام‌گذاری خودکار
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                    <!---->
                                                                    <div class="px-2 font-weight-bold mt-3"
                                                                        style="min-height: 38px;">
                                                                        <input style="color: black;" type="text"
                                                                            id="warningName" name="warningName"
                                                                            class="form-control" value="<%= old('warningName') %>">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                                <div class="d-flex px-2 mb-2">
                                                    <button type="submit" class="btn btn-block btn-success ml-1 mt-2">
                                                        ثبت هشدار
                                                    </button>
                                                    <button type="submit" data-dismiss="modal" aria-label="Close"
                                                        class="btn btn-block btn-outline-danger mr-1 mt-2">
                                                        انصراف
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>

    const searchBox = document.getElementById('searchInputControl');
    const detailsContainer = document.getElementById('namad-details-container');
    const bidaskTable = document.getElementById('bidaskTable');
    const failedMessage = document.getElementById('failed-message');
    const compareField = document.getElementById('compare-field');
    const comparator = document.getElementById('comparator');
    const compareNumber = document.getElementById('compareNumber');
    const warningName = document.getElementById('warningName');
    const customCheck = document.getElementById('customCheck');

    customCheck.checked = true;
    warningName.setAttribute('readonly', true);

    searchBox.value && symbolDataRequest();

    searchBox.addEventListener('keyup', async (e) => {
        symbolDataRequest();
    });

    compareField.addEventListener('change', (e) => {
        if(e.target.value == 1 || e.target.value == 3) validatePercentFields(compareNumber.value);
        warnigNameCompleter();
    })

    comparator.addEventListener('change', () => {
        warnigNameCompleter();
    })

    customCheck.addEventListener('change', (e) => {
        if(e.target.checked) {
            warnigNameCompleter();
            warningName.setAttribute('readonly', true);
        } else {
            warningName.value = '';
            warningName.removeAttribute('readonly');
        }
    })

    compareNumber.addEventListener('keyup', (e) => {
        let reg = /^-?\d*\.?\d*$/;

        if(reg.test(e.target.value)) warnigNameCompleter();
            else {
                e.target.value = '';
                customCheck.checked && warnigNameCompleter();
                Swal.fire({
                    title: 'لطفا فقط مقدار عددی را وارد این قسمت بکنید.',
                    type: 'error',
                    position: 'top-right',
                    toast: true,
                    showConfirmButton: false,
                    timer: 5000
                })
            }

        if(compareField.value == 1 || compareField.value == 3) validatePercentFields(e.target.value);
    });

    warnigNameCompleter();

    function warnigNameCompleter() {
        if (customCheck.checked) {
            warningName.value = 
                `${compareField.options[compareField.selectedIndex].text.trim()} ${comparator.options[comparator.selectedIndex].text.trim()} ${compareNumber.value || 0}`;
        }
    }
    
    function symbolDataRequest() {
        $.ajax({
            url: '/warnings/namadSearch',
            data: { name: searchBox.value },
            method: 'POST',
            success: (data) => {
                failedMessage.style.display = 'none';
                detailsContainer.style.display = 'block';
                bidaskTable.style.display = 'block';
                bidaskTable.style.background = detailsContainer.style.background = 'aliceblue';
                bidaskTable.style.borderRadius = detailsContainer.style.borderRadius = '20px';
                detailsContainer.classList.add('my-4');

                detailsContainer.innerHTML = `
                    <div class="d-flex align-items-center p-2">
                        <div class="flex-grow-1">
                            <h6 class="mb-0 mr-2">${data.name}</h6>
                            <small class="text-muted mr-2">${data.data.desc}</small>
                        </div>
                        <div dir="ltr" class="h6 text-end mb-0">
                            <span> ${data.data.dealingPrice} </span>
                            <small class="${parseFloat(fixNumbers(data.data.dealingPricePercent)) >= 0 ? 'text-success' : 'text-danger'}"> (${data.data.dealingPricePercent}) </small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between p-2 border-top">
                        <div class="no-wrap">
                            <span class="text-muted">قیمت پایانی:</span>
                            <span dir="ltr" class="${parseFloat(fixNumbers(data.data.lastPricePercent)) >= 0 ? 'text-success' : 'text-danger'}"> (${data.data.lastPricePercent})
                            </span>
                            ${data.data.lastPrice}
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="text-muted ml-1">حجم:</span>
                            <span dir="ltr" class="d-block">${data.data.hajmMoamelat} M</span>
                        </div>
                    </div>
                `;

                bidaskTable.innerHTML = `
                    <div class="d-flex align-items-center justify-content-between p-2">
                        <div class="flex-grow-1 text-center">
                            <h6>جدول خرید و فروش</h6>
                            ${data.data.bidaskTable}
                        </div>
                    </div>
                `
                    ;
            },
            error: (req, status, error) => {
                detailsContainer.style.display = 'none';
                bidaskTable.style.display = 'none';
                failedMessage.style.display = 'flex';

                failedMessage.innerHTML = `<span class="badge badge-danger p-2 my-3">${req.responseText}</span>`
            }
        });
    }

    function fixNumbers(str) {
        const persianNumbers = [/۰/g, /۱/g, /۲/g, /۳/g, /۴/g, /۵/g, /۶/g, /۷/g, /۸/g, /۹/g],
            arabicNumbers = [/٠/g, /١/g, /٢/g, /٣/g, /٤/g, /٥/g, /٦/g, /٧/g, /٨/g, /٩/g];

        const replacePercent = str.replace('٪', '');
        let convertedStr = replacePercent.replace('٫', '.');

        if (typeof convertedStr === 'string') {
            for (var i = 0; i < 10; i++) {
                convertedStr = convertedStr.replace(persianNumbers[i], i).replace(arabicNumbers[i], i);
            }
        }

        return convertedStr;
    };

function validatePercentFields(value) {
    if(parseFloat(value) >= 10 || parseFloat(value) <= -10) {
        compareNumber.value = '';
        warnigNameCompleter();
        Swal.fire({
            title: 'با توجه به شرطی که شما تعیین کردید. مقدار این فیلد فقط میتواند بین 10- تا 10 باشد.',
            type: 'error',
            position: 'top-right',
            toast: true,
            showConfirmButton: false,
            timer: 7000
        })
    }
}
</script>